# Администраторские команды и функции

## Миграция базы данных

Для применения новых изменений в базе данных выполните следующие SQL-скрипты:

1. **add-admin-column.sql** - добавляет колонку `is_admin` в таблицу `users`
2. **create-referral-links-table.sql** - создает таблицу источников и добавляет `source_key` в таблицу `users`

## Команды для админов

### /stats_kfa930
Показывает общую статистику бота (только для админов):
- Количество пользователей
- Количество и сумма успешных пополнений
- Количество генераций фото и музыки

За три периода: за все время, за последние 7 дней, за сегодня.

### /stats_pw
Показывает статистику вовлеченности пользователей (только для админов):
- Количество повторных пополнений (пользователи, которые пополнили баланс 2+ раз)
- Количество пользователей с 2-мя генерациями
- Количество пользователей с 3-мя генерациями
- Количество пользователей с 4+ генерациями

За три периода: за все время, за последние 7 дней, за сегодня.

### /add_source <название> <ключевая_подстрока>
Создает новый источник для трекинга пользователей.

**Пример:**
```
/add_source telegramAds tgTrack-PJ43a51379bd0a7a9
```

После создания источника будет доступна команда для просмотра его статистики: `/stats_<название>`

### /list_sources
Показывает список всех источников с их ключевыми подстроками и командами для просмотра статистики.

### /rename_source <старое_название> <новое_название>
Переименовывает источник.

**Пример:**
```
/rename_source неизвестный_источник_1 telegramAds
```

Это полезно когда автоматически создается неизвестный источник, и вы хотите дать ему понятное название.

### /stats_<название_источника>
Показывает статистику по конкретному источнику (только для админов).

**Пример:**
```
/stats_telegramAds
```

## Как работает трекинг пользователей

1. Пользователь переходит по ссылке вида: `https://t.me/Obrabotych_bot?start=tgTrack-PJ43a51379bd0a7a9`
2. При первом запуске бота (`/start`) система:
   - Проверяет, есть ли источник с ключом `tgTrack-PJ43a51379bd0a7a9` в базе
   - Если есть - привязывает пользователя к этому источнику
   - Если нет - создает новый "неизвестный_источник_N" и привязывает к нему
3. Все действия пользователя (пополнения, генерации) учитываются в статистике его источника

## Неизвестные источники

Если пользователь переходит по ссылке с ключом, который не был добавлен через `/add_source`, система автоматически создает источник с названием `неизвестный_источник_1`, `неизвестный_источник_2` и т.д.

Админ может просмотреть все источники через `/list_sources` и увидеть статистику неизвестных источников.

## Старые пользователи

Пользователи, зарегистрированные до внедрения системы трекинга, не привязаны ни к какому источнику (`source_key = NULL`). Они не учитываются в статистике источников, но учитываются в общей статистике.
